'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var _events=require('events'),_events2=_interopRequireDefault(_events),_immutable=require('immutable'),_immutable2=_interopRequireDefault(_immutable);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return call&&('object'==typeof call||'function'==typeof call)?call:self}function _inherits(subClass,superClass){if('function'!=typeof superClass&&null!==superClass)throw new TypeError('Super expression must either be null or a function, not '+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Flux=function(_EventEmitter){function Flux(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Flux);var _this=_possibleConstructorReturn(this,(Flux.__proto__||Object.getPrototypeOf(Flux)).call(this));return _this.config(a),_this._deregister=_this._deregister.bind(_this),_this._register=_this._register.bind(_this),_this.clearAppData=_this.clearAppData.bind(_this),_this.config=_this.config.bind(_this),_this.debugError=_this.debugError.bind(_this),_this.debugInfo=_this.debugInfo.bind(_this),_this.debugLog=_this.debugLog.bind(_this),_this.delLocalData=_this.delLocalData.bind(_this),_this.delSessionData=_this.delSessionData.bind(_this),_this.deregisterStore=_this.deregisterStore.bind(_this),_this.dispatch=_this.dispatch.bind(_this),_this.enableDebugger=_this.enableDebugger.bind(_this),_this.getClass=_this.getClass.bind(_this),_this.getLocalData=_this.getLocalData.bind(_this),_this.getSessionData=_this.getSessionData.bind(_this),_this.getStore=_this.getStore.bind(_this),_this.off=_this.off.bind(_this),_this.registerStore=_this.registerStore.bind(_this),_this.setLocalData=_this.setLocalData.bind(_this),_this.setSessionData=_this.setSessionData.bind(_this),_this.setStore=_this.setStore.bind(_this),_this._store=(0,_immutable.Map)(),_this._storeClasses=(0,_immutable.Map)(),_this._window=window||{},_this.DEBUG_DISABLED=0,_this.DEBUG_LOGS=1,_this.DEBUG_DISPATCH=2,_this.config(a),_this}return _inherits(Flux,_EventEmitter),_createClass(Flux,[{key:'_deregister',value:function _deregister(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'';this._storeClasses=this._storeClasses.delete(a),this._store=this._store.delete(a)}},{key:'_register',value:function _register(a){if(!a)throw Error('Class is undefined. Cannot register with Flux.');var b=a.constructor.toString().substr(0,5);if('class'!==b&&'funct'!==b)throw Error(a+' is not a class. Cannot register with Flux.');var c=new a,d=c.name;if(!this._storeClasses.get(d)){this._storeClasses=this._storeClasses.set(d,c);var e=this.getSessionData(this._name),f=this._useCache&&_immutable.Map.isMap(e)?e:(0,_immutable.Map)(),g=this._store.get(d)||f.get(d)||c.getInitialState()||(0,_immutable.Map)();this._store=this._store.set(d,g),this._useCache&&this.setSessionData(this._name,this._store)}return this._storeClasses.get(d)}},{key:'clearAppData',value:function clearAppData(){var _this2=this;this._storeClasses.forEach(function(a){_this2._store=_this2._store.set(a.name,_immutable2.default.fromJS(a.getInitialState()))}),this.setSessionData(this._name,this._store)}},{key:'config',value:function config(a){this._options=_immutable2.default.fromJS(a||{}),this._name=this._options.get('name','arkhamjs'),this._useCache=this._options.get('useCache',!0),this._useCache&&(this._store=this.getSessionData(this._name)||(0,_immutable.Map)()),this._debugLevel=this._options.get('debugLevel',this.DEBUG_DISABLED)}},{key:'debugError',value:function debugError(){var _console;for(var _len=arguments.length,a=Array(_len),_key=0;_key<_len;_key++)a[_key]=arguments[_key];this._debugLevel&&(_console=console).error.apply(_console,a);var b=this._options.get('debugErrorFnc');b&&b.apply(void 0,[this._debugLevel].concat(a))}},{key:'debugInfo',value:function debugInfo(){var _console2;for(var _len2=arguments.length,a=Array(_len2),_key2=0;_key2<_len2;_key2++)a[_key2]=arguments[_key2];this._debugLevel&&(_console2=console).info.apply(_console2,a);var b=this._options.get('debugInfoFnc');b&&b.apply(void 0,[this._debugLevel].concat(a))}},{key:'debugLog',value:function debugLog(){var _console3;for(var _len3=arguments.length,a=Array(_len3),_key3=0;_key3<_len3;_key3++)a[_key3]=arguments[_key3];this._debugLevel&&(_console3=console).log.apply(_console3,a);var b=this._options.get('debugLogFnc');b&&b.apply(void 0,[this._debugLevel].concat(a))}},{key:'delLocalData',value:function delLocalData(a){if(this._window&&this._window.localStorage)try{return this._window.localStorage.removeItem(a),!0}catch(b){return!1}else return!1}},{key:'delSessionData',value:function delSessionData(a){if(this._window&&this._window.sessionStorage)try{return this._window.sessionStorage.removeItem(a),!0}catch(b){return!1}else return!1}},{key:'deregisterStore',value:function deregisterStore(a){var _this3=this;Array.isArray(a)?a.forEach(function(b){_this3._deregister(b)}):this._deregister(a)}},{key:'dispatch',value:function dispatch(a){var _this4=this,b=1<arguments.length&&void 0!==arguments[1]&&arguments[1];a=_immutable2.default.fromJS(a);var c=a.get('type'),d=a.filter(function(f,g){return'type'!==g});if(c){var _e=this._store;if(this._storeClasses.forEach(function(f){var g=f.name,h=_this4._store.get(g)||f.getInitialState()||(0,_immutable.Map)();_this4._store=_this4._store.set(g,f.onAction(c,d,h)||h),f.state=_this4._store.get(g)}),this._debugLevel>this.DEBUG_LOGS){var f=!this._store.equals(_e),g=f?'Changed State':'Unchanged State',h=f?'#00d484':'#959595';console.groupCollapsed?(console.groupCollapsed('FLUX DISPATCH: '+c),console.log('%c Action: ','color: #00C4FF',a.toJS()),console.log('%c Last State: ','color: #959595',_e.toJS()),console.log('%c '+g+': ','color: '+h,this._store.toJS()),console.groupEnd()):(console.log('FLUX DISPATCH: '+c),console.log('Action: '+a.toJS()),console.log('Last State: ',_e.toJS()),console.log(g+': ',this._store.toJS()))}return this._useCache&&this.setSessionData(this._name,this._store),b||this.emit(c,d),a}}},{key:'enableDebugger',value:function enableDebugger(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0;this._debugLevel=a}},{key:'getClass',value:function getClass(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'';return this._storeClasses.get(a)}},{key:'getLocalData',value:function getLocalData(a){if(this._window&&this._window.localStorage)try{var b=this._window.localStorage.getItem(a);return b?_immutable2.default.fromJS(JSON.parse(b)):null}catch(b){return null}else return null}},{key:'getSessionData',value:function getSessionData(a){if(this._window&&this._window.sessionStorage)try{var b=this._window.sessionStorage.getItem(a);return b?_immutable2.default.fromJS(JSON.parse(b)):null}catch(b){return null}else return null}},{key:'getStore',value:function getStore(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',b=arguments[1];return Array.isArray(a)?this._store.getIn(a,b):''===a?this._store||(0,_immutable.Map)():this._store.get(a,b)}},{key:'off',value:function off(a,b){this.removeListener(a,b)}},{key:'registerStore',value:function registerStore(a){var _this5=this;return Array.isArray(a)?a.map(function(b){return _this5._register(b)}):this._register(a)}},{key:'setLocalData',value:function setLocalData(a,b){if(this._window&&this._window.localStorage)try{return _immutable2.default.Iterable.isIterable(b)&&(b=b.toJS()),b=JSON.stringify(b),this._window.localStorage.setItem(a,b),!0}catch(c){return!1}else return!1}},{key:'setSessionData',value:function setSessionData(a,b){if(this._window&&this._window.sessionStorage)try{return _immutable2.default.Iterable.isIterable(b)&&(b=b.toJS()),b=JSON.stringify(b),this._window.sessionStorage.setItem(a,b),!0}catch(c){return!1}else return!1}},{key:'setStore',value:function setStore(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',b=arguments[1];return Array.isArray(a)?this._store=this._store.setIn(a,b):''===a?this._store||(0,_immutable.Map)():this._store=this._store.set(a,b)}}]),Flux}(_events2.default);var flux=new Flux((window||{}).arkhamjs);exports.default=flux;