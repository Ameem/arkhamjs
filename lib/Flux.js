'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var _events=require('events'),_events2=_interopRequireDefault(_events),_immutable=require('immutable'),_immutable2=_interopRequireDefault(_immutable);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj)!(0<=keys.indexOf(i))&&Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return call&&('object'==typeof call||'function'==typeof call)?call:self}function _inherits(subClass,superClass){if('function'!=typeof superClass&&null!==superClass)throw new TypeError('Super expression must either be null or a function, not '+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var Flux=function(_EventEmitter){function Flux(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Flux);var _this=_possibleConstructorReturn(this,(Flux.__proto__||Object.getPrototypeOf(Flux)).call(this));return _this._window=window||{},b=_immutable2.default.fromJS(b),_this._debug=!!b.get('debug',!1),_this._name='arkhamjs',_this._store=_this.getSessionData(_this._name)||(0,_immutable.Map)(),_this._storeClasses=(0,_immutable.Map)(),_this._useCache=!!b.get('cache',!0),_this._window=window||{},_this}return _inherits(Flux,_EventEmitter),_createClass(Flux,[{key:'off',value:function off(b,c){this.removeListener(b,c)}},{key:'dispatch',value:function dispatch(){var _this2=this;for(var _len=arguments.length,b=Array(_len),_key=0;_key<_len;_key++)b[_key]=arguments[_key];var c=_immutable2.default.fromJS(b);return c.forEach(function(d){if(d.get('type')){var _d$toJS=d.toJS(),e=_d$toJS.type,f=_objectWithoutProperties(_d$toJS,['type']);f=_immutable2.default.fromJS(f);var _g=_this2._store;if(_this2._storeClasses.forEach(function(h){var i=h.name,j=_this2._store.get(i)||_immutable2.default.fromJS(h.initialState())||(0,_immutable.Map)();_this2._store=_this2._store.set(i,h.onAction(e,f,j)||j),h.state=_this2._store.get(i)}),_this2._debug){var h=!_this2._store.equals(_g),i=h?'Changed State':'Unchanged State',j=h?'#00d484':'#959595';console.group?(console.group('%c FLUX DISPATCH: '+e,'font-weight:700'),console.log('%c Action: ','color: #00C4FF',d.toJS()),console.log('%c Last State: ','color: #959595',_g.toJS()),console.log('%c '+i+': ','color: '+j,_this2._store.toJS()),console.groupEnd()):(console.log('FLUX DISPATCH: '+e),console.log('Action: '+d.toJS()),console.log('Last State: ',_g.toJS()),console.log(i+': ',_this2._store.toJS()))}_this2._useCache&&_this2.setSessionData(_this2._name,_this2._store),_this2.emit(e,f)}}),c}},{key:'getStore',value:function getStore(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',c=arguments[1];return Array.isArray(b)?this._store.getIn(b,c):''===b?this._store||(0,_immutable.Map)():this._store.get(b,c)}},{key:'registerStore',value:function registerStore(b){var c=new b,d=c.name;if(!this._storeClasses.has(d)){this._storeClasses=this._storeClasses.set(d,c);var e=this.getSessionData(this._name),f=this._useCache&&_immutable.Map.isMap(e)?e:(0,_immutable.Map)(),g=this._store.get(d)||f.get(d)||_immutable2.default.fromJS(c.initialState())||(0,_immutable.Map)();this._store=this._store.set(d,g),this._useCache&&this.setSessionData(this._name,this._store)}return this._storeClasses.get(d)}},{key:'deregisterStore',value:function deregisterStore(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'';this._storeClasses=this._storeClasses.delete(b),this._store=this._store.delete(b)}},{key:'getClass',value:function getClass(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'';return this._storeClasses.get(b)}},{key:'setSessionData',value:function setSessionData(b,c){if(this._window&&this._window.sessionStorage)try{return _immutable2.default.Iterable.isIterable(c)&&(c=c.toJS()),c=JSON.stringify(c),this._window.sessionStorage.setItem(b,c),!0}catch(d){return!1}else return!1}},{key:'getSessionData',value:function getSessionData(b){if(this._window&&this._window.sessionStorage)try{return _immutable2.default.fromJS(JSON.parse(this._window.sessionStorage.getItem(b)||'""'))}catch(c){return null}else return null}},{key:'delSessionData',value:function delSessionData(b){if(this._window&&this._window.sessionStorage)try{return this._window.sessionStorage.removeItem(b),!0}catch(c){return!1}else return!1}},{key:'clearAppData',value:function clearAppData(){this.delSessionData(this._name)}},{key:'setLocalData',value:function setLocalData(b,c){if(this._window&&this._window.localStorage)try{return _immutable2.default.Iterable.isIterable(c)&&(c=c.toJS()),c=JSON.stringify(c),this._window.localStorage.setItem(b,c),!0}catch(d){return!1}else return!1}},{key:'getLocalData',value:function getLocalData(b){if(this._window&&this._window.localStorage)try{return _immutable2.default.fromJS(JSON.parse(this._window.localStorage.getItem(b)||'""'))}catch(c){return null}else return null}},{key:'delLocalData',value:function delLocalData(b){if(this._window&&this._window.localStorage)try{return this._window.localStorage.removeItem(b),!0}catch(c){return!1}else return!1}},{key:'enableDebugger',value:function enableDebugger(){var b=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this._debug=b}}]),Flux}(_events2.default);var flux=new Flux((window||{}).arkhamjs);exports.default=flux;